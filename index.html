<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Gestão de Utilizadores</title>
</head>
<body>
  <h2>Utilizadores haha</h2>

  <input type="text" id="pesquisa" placeholder="Pesquisar por nome haha">
  <button onclick="listarUtilizadores()">Pesquisar haha</button>

  <table border="1">
    <thead>
      <tr><th>Nome</th><th>Email</th><th>Ações</th></tr>
    </thead>
    <tbody id="tabela-utilizadores"></tbody>
  </table>

  <h3>Editar Utilizador</h3>
  <input type="hidden" id="ID">
  <input type="text" id="nome" placeholder="Name">
  <input type="email" id="email" placeholder="Email">
  <button onclick="guardarEdicao()">Guardar</button>

  <script type="module">
    // Configuração Firebase
    import { initializeApp } from "firebase/app";
    import { getAnalytics } from "firebase/analytics";
    //import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where,
      doc, updateDoc, deleteDoc
    } 
    //from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    from "firebase/app";
    
    const firebaseConfig = {
      apiKey: "AIzaSyDwLJ5s5F9af3niIgw8e8ImH6B-Moan9XY",
      authDomain: "oneticket-6bd78.firebaseapp.com",
      projectId: "oneticket-6bd78",
      storageBucket: "oneticket-6bd78.firebasestorage.app",
      messagingSenderId: "152885209848",
      appId: "1:152885209848:web:cf29e0b754f372ca58a90d",
      measurementId: "G-6K1LDSF0JY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function listarUtilizadores() {
      const nomePesquisa = document.getElementById("pesquisa").value.toLowerCase();
      const tabela = document.getElementById("tabela-utilizadores");
      tabela.innerHTML = "";

      alert("Step 1!");
      
      const q = nomePesquisa
        ? query(collection(db, "User"), where("Name", ">=", nomePesquisa), where("Name", "<=", nomePesquisa + '\uf8ff'))
        : collection(db, "User");

      alert("Step 2!");
      
      const snapshot = await getDocs(q);
      snapshot.forEach(docSnap => {
        const dados = docSnap.data();
        const row = `<tr>
          <td>${dados.Name}</td>
          <td>${dados.Email}</td>
          <td>
            <button onclick="editar('${docSnap.id}', '${dados.Name}', '${dados.Email}')">Editar</button>
            <button onclick="apagar('${docSnap.id}')">Apagar</button>
          </td>
        </tr>`;
        tabela.innerHTML += row;
      });
      alert("Step 3!");
    }

    window.editar = function(id, nome, email) {
      document.getElementById("ID").value = id;
      document.getElementById("Name").value = nome;
      document.getElementById("Email").value = email;
    };

    window.guardarEdicao = async function() {
      const id = document.getElementById("ID").value;
      const nome = document.getElementById("Name").value;
      const email = document.getElementById("Email").value;

      const ref = doc(db, "User", id);
      await updateDoc(ref, { Name, Email });
      alert("Utilizador atualizado!");
      listarUtilizadores();
    };

    window.apagar = async function(id) {
      const ref = doc(db, "User", id);
      await deleteDoc(ref);
      alert("Utilizador removido!");
      listarUtilizadores();
    };

    listarUtilizadores();
  </script>
</body>
</html>
